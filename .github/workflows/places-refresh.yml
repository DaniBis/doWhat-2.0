name: Nightly Places Refresh

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch: {}

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Print runner info
        run: |
          echo "Runner: $RUNNER_OS"
          uname -a
          date

      - name: Trigger places refresh
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          PLACES_REFRESH_ENDPOINT: ${{ secrets.PLACES_REFRESH_ENDPOINT }}
        run: |
          set -o pipefail
          # fail early with clear message if a required secret is missing
          if [ -z "${CRON_SECRET:-}" ]; then
            echo 'ERROR: CRON_SECRET missing'
            exit 1
          fi
          if [ -z "${PLACES_REFRESH_ENDPOINT:-}" ]; then
            echo 'ERROR: PLACES_REFRESH_ENDPOINT missing'
            exit 1
          fi

          # Perform the POST and capture HTTP status and body
          HTTP_STATUS_AND_BODY=$(curl -s -w "\n%{http_code}" -X POST "$PLACES_REFRESH_ENDPOINT" \
            -H "x-cron-secret: $CRON_SECRET" \
            -H 'content-length: 0' \
            --max-time 30) || true

          # Separate body and status
          RESPONSE_CODE=$(echo "$HTTP_STATUS_AND_BODY" | tail -n1)
          echo "HTTP response code: $RESPONSE_CODE"
          echo "Response body:"
          echo "$HTTP_STATUS_AND_BODY" | sed '$d' || true

          if [ -z "$RESPONSE_CODE" ]; then
            echo "ERROR: no HTTP status returned" >&2
            exit 1
          fi

          if [ "$RESPONSE_CODE" -ge 400 ]; then
            echo "Places refresh failed with status $RESPONSE_CODE" >&2
            exit 1
          fi

          echo "Places refresh succeeded (status $RESPONSE_CODE)"
