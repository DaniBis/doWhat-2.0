name: Nightly Places Refresh

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch: {}

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Print runner info
        run: |
          echo "Runner: $RUNNER_OS"
          uname -a
          date

      - name: Trigger places refresh
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          PLACES_REFRESH_ENDPOINT: ${{ secrets.PLACES_REFRESH_ENDPOINT }}
        run: |
          set -o pipefail
          if [ -z "${CRON_SECRET:-}" ]; then
            echo 'ERROR: CRON_SECRET missing'
            exit 1
          fi

          if [ -n "${PLACES_REFRESH_ENDPOINT:-}" ]; then
            TARGET_ENDPOINT="$PLACES_REFRESH_ENDPOINT"
          else
            TARGET_ENDPOINT='https://dowhat.app/api/places/refresh'
            echo 'PLACES_REFRESH_ENDPOINT secret missing, using https://dowhat.app/api/places/refresh'
          fi

          echo "Triggering places refresh via $TARGET_ENDPOINT"

          HTTP_STATUS_AND_BODY=$(curl -s -w "\n%{http_code}" -X POST "$TARGET_ENDPOINT" \
            -H "x-cron-secret: $CRON_SECRET" \
            -H 'content-length: 0' \
            --max-time 30) || true

          BODY=$(echo "$HTTP_STATUS_AND_BODY" | sed '$d')
          RESPONSE_CODE=$(echo "$HTTP_STATUS_AND_BODY" | tail -n1)
          echo "HTTP response code: $RESPONSE_CODE"
          echo "Response body:"
          echo "$BODY"

          if [ -z "$RESPONSE_CODE" ]; then
            echo "ERROR: no HTTP status returned" >&2
            exit 1
          fi

          if [ "$RESPONSE_CODE" -ge 400 ]; then
            echo "Places refresh failed with status $RESPONSE_CODE" >&2
            exit 1
          fi

          echo "Places refresh succeeded (status $RESPONSE_CODE)"
