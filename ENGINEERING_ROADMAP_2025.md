# Engineering Roadmap ‚Äî December 2025

This roadmap reflects the current state of branch `feature/admin-dashboard-docs` and outlines the next major efforts to close remaining gaps across mobile, web, shared packages, and Supabase.

## 0. doWhat Core Transformation (New High Priority ¬∑ Est. 3‚Äì4 sprints)
	- Ship migration `035_social_sweat_core.sql` introducing profile reliability columns, sport metadata, attendance enums, `session_open_slots`, and (per architecture review) a dedicated `user_sport_profiles` table so trait vibes remain decoupled from structured skill data.
	- Regenerate Supabase types plus shared TypeScript enums immediately so web/mobile compile before new UI lands.
		- ‚úÖ 10 Dec: Centralized the doWhat sport/play/attendance enums + labels in `@dowhat/shared`, re-exported them via `apps/doWhat-web/src/types/database.ts`, and updated the host attendance UI to consume the shared helpers.
	- Add seed + rollback scripts plus health checks inside `database_updates.sql` to keep deploy parity.
	- ‚úÖ 12 Dec: Added `scripts/health-migrations.mjs` (wired into `pnpm run health`) and documented the quick-check step in `database_updates.sql` + `docs/migrations_025-031_validation.md`.
	- Stand up `packages/shared/src/sports`, `scoring/reliability.ts`, and `recommendations/rankSessions.ts` with exhaustive Jest coverage.
	- Move palette/spacing tokens into `packages/shared/theme` to prevent Next.js vs Expo drift when new Sport/Skill chips land.
	- Web + mobile onboarding steps for Sport & Skill use the shared taxonomy and persist into `user_sport_profiles`/profiles in lockstep.
	- `/admin/new` gains "Looking for Players" inputs that create `session_open_slots` rows alongside sessions, guarded by feature flags until QA.
	- Mobile home feed surfaces "Find a 4th Player" cards ranked via the shared scorer; map remains secondary to avoid the "ghost town" effect in new cities.
	- ‚úÖ Host attendance tooling (`SessionAttendancePanel`) now records definitive statuses via a host-only roster, the companion API (`/api/sessions/[id]/attendance/host`) enforces host auth + writes `session_attendees`, and a Postgres trigger (`036_attendance_reliability_trigger.sql`) clamps reliability scores immediately; the GPS verification signal now shows up in attendance badges/analytics so ‚Äúverified matches‚Äù are both visible and tracked.
	- ‚úÖ 13 Dec: Finished wiring the Find-a-4th hero on mobile with live data + telemetry; `HomeScreen` now pulls from `useRankedOpenSessions`, emits `trackFindA4thImpression`/`trackFindA4thCardTap` with full session metadata, and is covered by a focused RN Jest suite (`apps/doWhat-mobile/src/app/__tests__/home.findA4th.test.tsx`) that stubs background location, Supabase, and Expo Router to guarantee we keep testing navigation + analytics end-to-end.
- **Onboarding Telemetry (in-flight guardrail):**
	- ‚úÖ 12 Dec: Every onboarding CTA (profile progress banner, nav pill, sport/traits/pledge banners on web + mobile, people-filter reminders, sport selectors, and the onboarding hub cards) now emits the prioritized `step`, full `steps` array, and `pendingSteps` count through `trackOnboardingEntry`, with matching Jest coverage so analytics can tie each event to the exact Step 0 shortfall.
- ‚úÖ 13 Dec: Finished the shared theme token sweep across `/admin`, `/discover`, and `/map` experiences so all high-traffic screens now rely on `packages/shared/src/theme.ts` palette + spacing primitives (brand teal accents, feedback backgrounds, px/py token spacing). Followed up with `pnpm --filter dowhat-web test -- --runInBand` plus focused admin suites to confirm no behavioral regressions while visual styles changed.
	- ‚úÖ 13 Dec: Extended the same theme tokens to the session attendance stack (`SessionAttendancePanel`, `SessionAttendanceList`), `ActivityCard`, and `EmailAuth`, covering chips, focus rings, toast banners, and CTA buttons with the doWhat palette; reran the focused Jest suites for SessionAttendancePanel and ActivityCard to keep host tooling + saved-activity coverage green.
- ‚úÖ 13 Dec: Rounded out the onboarding/home polish by updating `AuthButtons`, the home hero CTA, profile traits banner/badge pills, and the `SportSelector` (including its inline skill chips) to the shared brand + feedback tokens, keeping Step 0 CTA tests (`apps/doWhat-web/src/app/profile/__tests__/page.test.tsx`, `components/onboarding/__tests__/SportSelector.test.tsx`) green.
- ‚úÖ 13 Dec: Stabilized the shared theme sweep by rerunning `pnpm -w run typecheck`, `pnpm -w run lint`, and the Step 0 CTA suites above so lint/typecheck stay green and the guardrail tests prove the visual refactors remain telemetry-safe; captured the verification in `docs/handoff/ACTIVE_WORK_AND_RISKS.md`.
- ‚úÖ 13 Dec: Re-executed the broader regression pack (`pnpm --filter dowhat-web exec playwright test` for all 10 admin e2e specs and `pnpm test -- --maxWorkers=50%` for every workspace Jest suite) to confirm the branch remains stable after the palette migration and onboarding CTA tweaks; recorded the passing runs in the handoff docs/log.
- **Validation & Pilot (Sprint 4):**
	- `scripts/seed_social_sweat.ts` populates Bucharest pilot data for E2E + ranking tests.
		- ‚úÖ 12 Dec: Fixed the duplicate type definition in the seeder and documented the SUPABASE_URL/SUPABASE_SERVICE_ROLE_KEY prerequisites plus password overrides in `README.md`, so anyone can rerun the Bucharest pilot seed with deterministic credentials.
		- ‚úÖ 13 Dec: Added `docs/social_sweat_pilot_validation.md` with the step-by-step seeding + verification checklist and linked it from the README so the pilot runbook stays easy to find.
		- ‚úÖ 13 Dec: Introduced `scripts/verify-social-sweat.mjs` + `pnpm verify:social-sweat` to automatically confirm the hosts, venues, activities, sessions, open slots, and host attendance rows seeded correctly after each run.
		- ‚úÖ 13 Dec: Added the Adoption Metrics Validation Checklist for migration `038_social_sweat_adoption_metrics.sql` (documented in `docs/handoff/ACTIVE_WORK_AND_RISKS.md`) so engineers know the exact `pnpm run db:migrate` commands, SQL verification, dependent `/admin` cards, and Jest suites to run before sign-off.
	- ‚úÖ 12 Dec: The `/admin` doWhat readiness grid now includes a dedicated "Skill level saved" card (fed by `sport_skill_member_count`) so ops can track partial sport adoption separately from fully ready members.
	- Reliability badge components (web + RN) and Skill chips reuse shared tokens; analytics dashboards track adoption before public launch.
	- Architecture guardrails: run telemetry on fake-session risk, ensure open-slot RLS policies are exercised via Playwright + Jest.
		- ‚úÖ 12 Dec: `/admin/new` now tags open-slot publishes with manual-entry flags, coordinate coverage, and a fake-session risk score, plus rolls sessions back when `session_open_slots` inserts fail (RTL simulates an RLS denial while the Playwright spec continues to exercise the happy path).

## Sprint 5 ‚Äî Engagement & Safety Execution Plan (Completed ¬∑ 14 Dec 2025)

### Mandates & Global Constraints
- Mandate A ‚Äî Kill the Silence: deliver day-1 SMS notifications for hosts using Supabase Edge Functions + Twilio; trigger when a `session_attendees` row is inserted; dedupe, rate limit, and document env requirements.  
- Mandate B ‚Äî Viral Loop: add dynamic Open Graph images for WhatsApp cards so session links preview sport/venue/slot info; keep endpoints unauthenticated and aligned with App Router conventions.  
- Mandate C ‚Äî Defensive Reliability: introduce dispute persistence + trust UI (report issue flow, transparent reliability badges, basic moderation fields).  
- Constraints: no Step 0 regressions, additive migrations only, env/config changes documented, run lint/typecheck/web Jest/`pnpm health`/Playwright after each phase, reuse existing patterns (Next.js App Router, Expo managed, Supabase Postgres + Edge Functions).

### Phase A ‚Äî Notification Engine (Twilio SMS via Supabase) ¬∑ Completed 14 Dec 2025
- **DB migration:** `apps/doWhat-web/supabase/migrations/0XX_notification_outbox.sql` adding `notification_outbox` table (event metadata, dedupe key, attempt counters, service-role RLS) plus `session_attendees` trigger that enqueues `attendee_joined` rows idempotently.  
- **Edge Function:** `supabase/functions/notify-sms/index.ts` polling pending outbox rows, sending Twilio SMS (`TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_FROM_NUMBER`, `PUBLIC_BASE_URL`), capping retries at 3, recording errors, respecting per-session throttling.  
- **Scheduling:** hook into Supabase cron (or document secure admin trigger) so the function runs continuously; update docs/env templates accordingly.  
	- ‚úÖ 14 Dec: Installed `pg_cron` on `kdviydoftmjuglaglsmm` (`create extension if not exists pg_cron with schema cron`), stored the project URL + notify admin key via `vault.create_secret`, and applied `supabase/functions/notify-sms/schedule.sql` so `cron.job` now lists an active `notify-sms-every-minute` entry. Re-ran the manual notify script afterward and confirmed the new row returned `status: "sent"`, proving the cron + secrets wiring works before we lean on pg_cron for delivery.  
- ‚úÖ 13 Dec: Added `supabase/config.toml` (JWT disabled for `notify-sms`) plus `supabase/functions/notify-sms/schedule.sql`, a pg_cron template that posts to the Edge Function every minute using Vault-managed secrets; README + handoff docs now include the Vault + `psql` steps for each environment.  
- ‚úÖ 13 Dec: `scripts/health-env.mjs` now lists `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_FROM_NUMBER`, and `NOTIFICATION_ADMIN_KEY` as required so `pnpm health` fails fast when notification credentials are missing.  
- ‚úÖ 13 Dec: Added `NOTIFICATION_TWILIO_STUB` + `NOTIFICATION_TWILIO_STUB_TO` support inside the Edge Function so local/staging dry runs can log payloads without contacting Twilio; the health script treats the Twilio creds as optional whenever the stub flag is enabled.  
- ‚úÖ 13 Dec: Introduced `scripts/health-notifications.mjs` and wired it into `pnpm health` so pending rows older than 15 minutes or recent failures flip the health check red, providing a cron/Twilio early-warning system.  
- **Health/Test:** extend `pnpm health` (or dedicated test) to assert the migration + outbox table exist; add Twilio mock coverage if feasible.  
	- ‚úÖ 14 Dec: Extracted the Twilio send helper into `supabase/functions/notify-sms/twilio.ts`, added a dedicated Jest project (`supabase/functions/jest.config.js`) with stub/live flow coverage (`notify-sms/__tests__/twilio.test.ts`), and wired the suite into `pnpm test` so Mandate A‚Äôs notification guardrail now verifies both the migration/outbox health script and the Twilio mock path automatically.
	- ‚úÖ 14 Dec: Re-ran `pnpm health` (env, migrations, notification outbox, trait policies, doWhat verifier) plus the focused `supabase/functions/notify-sms/__tests__/twilio.test.ts` suite to confirm the notification stack stays green before wiring the Edge Function into cron.
	- ‚úÖ 14 Dec: Deployed the `notify-sms` Edge Function to `kdviydoftmjuglaglsmm`, stored `NOTIFICATION_ADMIN_KEY` + Twilio stub secrets via `supabase secrets set`, and re-ran `node scripts/manual-notify-sms-run.mjs` so the seeded outbox row (plus the prior failure) now returns `{ status: "sent", last_error: null }`. Manual verification is green; next step is wiring pg_cron with `supabase/functions/notify-sms/schedule.sql`.
- **Acceptance:** joining a session produces exactly one outbox row, SMS fires once, failures recorded without spam.
	- ‚úÖ 14 Dec: Seeded a temporary `session_attendees` row (status `going`, attendance `registered`) for session `5bce63c0‚Ä¶` via the service role, which produced outbox id `ca9ed5d7-6c2e-4c25-8e38-bfbb8586067e`. After enabling `pg_net`, the scheduled job (run id 9) picked it up automatically and advanced the row to `status: sent` with `attempt_count = 1`, `last_error = null` with no duplicate inserts. The test attendee + host contact change were rolled back immediately afterward.

### Phase B ‚Äî WhatsApp Card (Dynamic Open Graph Images) ¬∑ Completed 14 Dec 2025
- **OG endpoint:** `apps/doWhat-web/src/app/sessions/[id]/opengraph-image.tsx` (ImageResponse) fetching sport, venue, open slots, skill, and start time to render a WhatsApp-friendly preview (‚Äúüéæ Sport @ Venue ‚Ä¢ Need 1 Intermediate ‚Ä¢ Tue 19:00‚Äù).  
- **Metadata wiring:** update `apps/doWhat-web/src/app/sessions/[id]/page.tsx` `generateMetadata()` to include absolute `openGraph.images` + Twitter metadata pointing at the new OG route; ensure unauthenticated access and caching guidance.  
- **Validation:** add snapshot/unit test if precedent exists; otherwise document manual verification steps in docs/README.
	- ‚úÖ 14 Dec: Added a "Session share previews" section in `README.md` plus `docs/current_app_overview_2025-12-03.md` that walks through verifying `/sessions/<id>/opengraph-image` locally (or via `ngrok`) so contributors can rerun the WhatsApp/OG preview check without bespoke tests.
	- ‚úÖ 14 Dec: Re-ran the full guardrail stack after fixing the OG handler and lint issues‚Äî`pnpm -w run typecheck`, `pnpm -w run lint`, `pnpm --filter dowhat-web test -- --runInBand`, `pnpm --filter dowhat-web exec playwright test`, and `SOCIAL_SWEAT_HEALTH_SKIP=1 pnpm run health` followed by `curl -s http://localhost:3002/api/health`. The health probe currently returns `missing:["user_traits"]` on this machine because the local database hasn‚Äôt been seeded with Step 0 tables yet; expect the warning until the seed runs.
	- ‚úÖ 14 Dec: Manually validated the OG route by running `pnpm --filter dowhat-web dev` locally and curling `http://localhost:3002/sessions/5bce63c0-413b-57b1-9c36-02af57eafc54/opengraph-image` (image saved to `/tmp/og.png`, HTTP 200). Logged the run in `ASSISTANT_CHANGES_LOG.md` so future contributors can trace the verification.
- ‚úÖ 13 Dec: Implemented the OG endpoint + metadata wiring so `/sessions/[id]` now serves a branded ImageResponse (doWhat gradient, slot + skill pills, venue/time rows) and advertises it through `generateMetadata` for both Open Graph + Twitter cards; helper utilities (`og-data.ts`) consolidate the Supabase fetch so metadata + image stay in sync.

### Phase C ‚Äî Trust & Safety UI (Reliability + Disputes) ¬∑ Completed 14 Dec 2025
- **DB migration:** `apps/doWhat-web/supabase/migrations/0XX_disputes.sql` introducing `attendance_disputes` (status workflow, reason/details, reporter ownership) with RLS (reporters read their own, service role reads all).  
- **Web UX:** expose reliability score + badge explanation on profile using existing shared helpers; add ‚ÄúReport Issue / Contest No-Show‚Äù modal on past session cards with reason/details form hitting a new authenticated API route (e.g., `apps/doWhat-web/src/app/api/disputes/route.ts`).  
- **Mobile parity:** lightweight Expo screen/modal triggered from past session detail posting to the same backend endpoint.  
- **Analytics/tests:** track submission events if analytics helper exists; add RTL coverage for modal success + auth failure, plus mobile Jest case when applicable.  
- **Acceptance:** members can submit/view their disputes, reliability UI clarifies scoring, and there‚Äôs a visible path to contest no-shows.
- ‚úÖ 13 Dec: `/api/disputes` now exposes a GET history view (50 entries, session metadata included) and the My Attendance page lists dispute timelines with status chips, manual refresh, and contest-button gating, covered by `apps/doWhat-web/src/app/my/attendance/__tests__/page.test.tsx`.
- ‚úÖ 13 Dec: The mobile profile now ships the full reliability & trust card ‚Äî reliability index, confidence, badge glossary, attendance stats, and a ‚ÄúView attendance log‚Äù CTA ‚Äî backed by the `/api/profile/[id]/reliability` endpoint and a refreshed RN Jest suite (`apps/doWhat-mobile/src/app/__tests__/profile.simple.cta.test.tsx`) covering loading, success, error, and CTA flows.
- ‚úÖ 15 Dec: Replaced the reliability card‚Äôs WebBrowser link with a native Expo attendance log screen (`/profile/attendance-log`) that queries Supabase `session_attendees` + the `mobile-disputes` Edge Function, mirrors the web dispute badges/history, exposes pull-to-refresh, and is covered by the updated RN Jest CTA suite.
- ‚úÖ 13 Dec: Added RTL coverage for the web `ReliabilityExplainer` (`apps/doWhat-web/src/components/profile/__tests__/ReliabilityExplainer.test.tsx`), guarding the profile trust card‚Äôs score, badge glossary, attendance percentages, and attendance-log CTA so the transparency UI stays regression-safe.
- ‚úÖ 13 Dec: Instrumented the ‚ÄúView attendance log‚Äù CTA on both platforms using a shared `trackReliabilityAttendanceLogViewed` helper (`packages/shared/src/analytics.ts`), ensuring the web profile card and the Expo reliability sheet both fire analytics before routing members to `/my/attendance`.
- ‚úÖ 13 Dec: Added first-time guidance to the reliability cards so members with no score yet see ‚ÄúAttend a few confirmed sessions‚Ä¶‚Äù copy on both web (`ReliabilityExplainer`) and mobile (`profile.simple.tsx`), locking the behavior down with refreshed Jest coverage.
- ‚úÖ 13 Dec: Added `trackReliabilityContestOpened` telemetry so the My Attendance ‚ÄúContest reliability‚Äù CTA records platform/surface/session metadata before opening the dispute modal, keeping the analytics trail intact via `apps/doWhat-web/src/app/my/attendance/__tests__/page.test.tsx`.
- ‚úÖ 13 Dec: Mirrored the contest CTA analytics on Expo by wiring `trackReliabilityContestOpened` into the mobile session detail modal and adding `apps/doWhat-mobile/src/app/__tests__/sessions.contest-analytics.test.tsx` so the mobile dispute flow now emits `{ platform: "mobile", surface: "session-detail" }` metrics before opening.
- ‚úÖ 13 Dec: Introduced `trackReliabilityDisputeHistoryViewed` so both the web My Attendance dispute fetch and the Expo session detail ‚ÄúView history‚Äù sheet emit `{ disputes }` telemetry; new Jest coverage in `apps/doWhat-web/src/app/my/attendance/__tests__/page.test.tsx` and `apps/doWhat-mobile/src/app/__tests__/sessions.contest-analytics.test.tsx` keeps the analytics wiring honest.
- ‚úÖ 14 Dec: Added a `source` dimension to the dispute-history analytics and instrumented manual refreshes plus post-submit reloads on web/mobile, with fresh Jest cases guarding the My Attendance refresh button and the Expo history sheet refresh control.
- ‚úÖ 14 Dec: Introduced `trackReliabilityDisputeHistoryFailed` so both surfaces log `{ source, error }` whenever history fetches fail, keeping trust telemetry aware of outages via the updated RTL and RN Jest suites.
- ‚úÖ 14 Dec: Added inline dispute badges to the My Attendance list using the shared status tokens so contested sessions immediately show their current state without scrolling to the history timeline; guarded the new UI with an RTL assertion.
- ‚úÖ 14 Dec: Extracted reusable dispute status tokens into `apps/doWhat-web/src/lib/disputes/statusTokens.ts`, refactored the My Attendance view to consume them, and shipped the allowlisted `/api/admin/disputes` GET/PATCH route (with audit logging + Supabase server/service clients) so moderators can review, filter, and resolve reports without touching the database directly.
- ‚úÖ 14 Dec: Built the `/admin/disputes` dashboard (filters, note drafting, status action buttons, Supabase auth gating) and added RTL coverage at `apps/doWhat-web/src/app/admin/disputes/__tests__/page.test.tsx` to ensure non-admins see the lock screen and moderator actions send the correct PATCH payloads before the UI refreshes.
- ‚úÖ 14 Dec: `/api/admin/disputes` now returns a `statusCounts` summary alongside totals, and the core `/admin` dashboard banner + nav pill surfaces those metrics (per-status chips, refresh controls, badge showing open count). Guarded by `apps/doWhat-web/src/app/api/admin/disputes/__tests__/route.test.ts` and `apps/doWhat-web/src/app/admin/__tests__/page.test.tsx` so the summary math, fetch wiring, and admin-only UI stay consistent.
- ‚úÖ 14 Dec: Linked the new disputes queue from the Admin dashboard (quick nav link + CTA banner) and added API route coverage (`apps/doWhat-web/src/app/api/admin/disputes/__tests__/route.test.ts`) that exercises allowlist enforcement, GET filters/limits, PATCH validation, and audit logging so both the UI and backend moderation tools are now regression-safe.
- ‚úÖ 14 Dec: Added dispute totals to the `/api/admin/disputes` GET response and surfaced the open-count summary on the main `/admin` banner (with a refresh control) so moderators see how many reports await review before opening the dedicated queue; refreshed the admin dashboard Jest suite to cover the new fetch + UI state.
- ‚úÖ 14 Dec: Hardened the dispute tooling typings by finishing the Supabase `Database` alias, normalizing the admin/user dispute APIs to account for PostgREST‚Äôs array-shaped relations, and routing `/admin/disputes` links through Next‚Äôs typed-route helper; reran `pnpm -w run typecheck` afterward (green) to keep the workspace clean before proceeding to the next mandate.
- ‚úÖ 14 Dec: Phase C sign-off ‚Äî reran `node scripts/verify-trait-policies.mjs` plus `pnpm test:onboarding-progress` after the dispute summary/nav badge work, updated the roadmap + overview docs, and confirmed all trust & safety API/UI suites stay green.

## 1. Complete Session Attendance Migration (Completed ¬∑ 12 Dec 2025)
- Replace all RSVP-era APIs/components (`RsvpBox`, `RsvpQuickActions`, `/api/rsvps`, etc.) with the new `session_attendees` tables and views delivered via migrations `027‚Äì030`.
- Ensure host actions, attendee badges, caps, and session detail pages on both platforms rely on the same data joins.
- Add targeted integration tests for attendance toggles, capacity checks, and saved sessions to prevent regressions.
	- ‚úÖ Added Jest coverage for the `/attendance/join` + `/attendance/leave` routes so auth failures, capacity enforcement, and success payloads stay regression-safe while we continue iterating on the remaining Step 1 tasks.
	- ‚úÖ Added matching coverage for `/attendance/host` (GET + POST) so host-only roster access, verified toggles, and Supabase update flows stay locked down.
	- ‚úÖ Added RTL coverage for `SessionAttendancePanel` so the host roster UI, verified badge, and ‚ÄúRecord attendance‚Äù action remain regression-safe.
	- ‚úÖ Added Jest coverage for the `/my/attendance` page so the saved-session list honors Supabase auth, hydrates attendee rows, optimistically toggles statuses, and surfaces query/mutation errors when the browser client fails.
	- ‚úÖ 12 Dec: Verified there are no remaining RSVP routes/usages in web/mobile, and removed the last `Rsvp*` alias exports from `apps/doWhat-web/src/components`.

## 2. Stabilize Saved Activities Context (Completed ¬∑ 12 Dec 2025)
- Fix the TypeScript issues in `apps/doWhat-mobile/src/contexts/SavedActivitiesContext.tsx` so typecheck/CI passes.
- Mirror the refined context logic on the web (or extract core helpers into `packages/shared`) to keep save/unsave flows in sync.
- Add unit tests around metadata normalization, optimistic updates, and fallback handling.
- **Update ¬∑ 4 Dec:** Added a dedicated RN Jest suite (`src/contexts/__tests__/SavedActivitiesContext.test.tsx`) plus a Jest alias for `@dowhat/shared`, so the mobile provider now has coverage for optimistic saves, fallbacks, and unsave toggles.
- **Update ¬∑ 9 Dec:** Extended the web provider suite (`apps/doWhat-web/src/contexts/__tests__/SavedActivitiesContext.test.tsx`) with per-table select errors plus a fallback-read test, proving the context walks through `READ_SOURCES` and reprioritizes legacy write targets when Supabase views go missing.
- **Update ¬∑ 9 Dec (mobile):** Mirrored the fallback-read coverage in `apps/doWhat-mobile/src/contexts/__tests__/SavedActivitiesContext.test.tsx`, ensuring the RN provider also advances through `READ_SOURCES` and prefers the legacy write target when `user_saved_activities_view` errors.
- **Update ¬∑ 11 Dec:** Introduced the shared `trackSavedActivityToggle` helper in `packages/shared/src/analytics.ts`, instrumented both SavedActivities providers with platform/source-aware telemetry, and added Jest coverage on web + mobile so every save/unsave event now emits analytics with consistent metadata.
- **Update ¬∑ 12 Dec:** Documented the Saved Activities health flow in `docs/current_app_overview_2025-12-03.md` plus the README instructions for re-running both context suites (`pnpm --filter dowhat-web test -- SavedActivitiesContext` + `pnpm --filter doWhat-mobile test -- SavedActivitiesContext`) and pairing them with `pnpm health`, closing out Step 2‚Äôs stabilization goals.

## 3. Ship Trait Onboarding & Profile Flows (Completed ¬∑ 14 Dec 2025)
	- Detailed validation plan now lives in `docs/trait_policies_test_plan.md`; run that script matrix before sign-off.
- Document the UX flows and add regression tests covering trait creation, editing, and personalization hints.
	- **Update ¬∑ 9 Dec:** Added Jest coverage for `src/app/onboarding/traits/page.tsx`, dynamically importing the server component so mocked Supabase auth + `next/navigation.redirect` hooks apply, and asserting unauthenticated users redirect to `/auth/login` while signed-in members see the Step 3 checklist/CTA block.
	- **Update ¬∑ 9 Dec:** Landed CTA regression tests on the profile traits tab and Smart Filters page (web + mobile). The new Expo suites stub Supabase auth/count queries, mock the popular traits fetch, and wrap React Native Animated warnings so the "Finish your base traits" banner only appears when fewer than five base traits exist, regardless of platform.
	- **Update ¬∑ 9 Dec:** Hardened the mobile trait selector with RN Jest coverage (`apps/doWhat-mobile/src/app/__tests__/onboarding-traits.test.tsx`), mocking safe areas/router, enforcing the five-trait cap, validating the insert/RPC fan-out on save, and asserting the "Please sign in again" error when Supabase auth is missing.
	- **Update ¬∑ 12 Dec:** Documented the trait onboarding regression plan in `README.md` (targeted Jest commands + `node scripts/verify-trait-policies.mjs` instructions) and mirrored the guidance in `docs/current_app_overview_2025-12-03.md`, ensuring Step 3 verification steps are discoverable before we mark the roadmap item complete.
	- **Update ¬∑ 12 Dec:** Added the new mobile onboarding hub UI + Jest suite (`apps/doWhat-mobile/src/app/__tests__/onboarding-index.test.tsx`), refreshed the README with "Onboarding progress" commands, and linked each Step 0 surface in `docs/current_app_overview_2025-12-03.md` to its guarding `pnpm test` invocation so contributors keep the prioritized CTA telemetry in sync.
	- **Update ¬∑ 12 Dec:** Landed the `OnboardingNavPrompt` on the mobile Home screen and the floating `OnboardingNavPill` above the tab bar (with RN tests in `apps/doWhat-mobile/src/components/__tests__/OnboardingNavPrompt.test.tsx` and `OnboardingNavPill.test.tsx`), so iOS/Android now mirror the web Step 0 nav CTA surfaces and fire the same telemetry payloads documented in the refreshed regression commands.
	- **Update ¬∑ 12 Dec:** Tightened the web `OnboardingNavLink` so it now requires play style + saved skill levels (via `user_sport_profiles`) before marking the sport step complete, keeping the global nav pill exactly in sync with the new mobile CTA logic; added Jest coverage in `apps/doWhat-web/src/components/nav/__tests__/OnboardingNavLink.test.tsx` to lock the behavior down.
	- **Update ¬∑ 12 Dec:** Added shared onboarding progress helpers in `@dowhat/shared` so both platforms reuse the same trait goal + pending-step logic (`derivePendingOnboardingSteps`, `hasCompletedSportStep`). The Expo hook and Next.js nav CTA now consume the helper, preventing future parity drift.
	- ‚úÖ 14 Dec: Re-ran `node scripts/verify-trait-policies.mjs` against the live Supabase project (all checks green) and recorded the latest verification timestamp inside `docs/current_app_overview_2025-12-03.md`, keeping Step 3‚Äôs policy matrix current after the Phase C dispute tooling landed.
	- ‚úÖ 14 Dec: Executed `pnpm test:onboarding-progress` (web + mobile CTA/banner suites) so Step 3‚Äôs UI/telemetry guardrails remain green following the admin dispute dashboard changes.
	- ‚úÖ 14 Dec: Roadmap sign-off ‚Äî Step 3 requirements are now fully met (traits onboarding/profile flows shipped on both platforms, policy verifier + CTA suites in place, docs updated with rerun instructions).

## 4. Achieve Web/Mobile Feature Parity (Completed ¬∑ 6 Dec 2025)
- **Status (6 Dec 2025):** Parity guardrails, docs, and Playwright suites are now in place across admin new/sessions/dashboard/venues plus the venue verification tooling, so work can shift to Step 5.
- Saved Activities parity is now complete across mobile, web, admin dashboards, and venue verification via the shared `@dowhat/shared` payload builders.
- Regression tests now cover the shared adapters (ActivityCard, ActivityScheduleBoard, venue save helper) plus the SavedActivitiesContext snapshots, and these suites now run inside the default `pnpm -w run test` CI step.
- Shared taxonomy + filter constants now live in `packages/shared` (taxonomy exports, `preferences/activityFilterOptions.ts`), and both Activity Filter screens consume the same distance/price/time presets so Supabase preferences stay canonical.
- The web People Filter now embeds the shared taxonomy picker + presets (and mobile pulls from the shared skill/age/group lists), keeping its Activity tab aligned with the main filter screen.
- Admin dashboard filters now expose the shared taxonomy/time-of-day presets so hosts can review sessions/venues with the same knobs as consumers.
- The `/admin/new` session flow now embeds the shared taxonomy picker, hydrates existing activity tags, and persists the selected tier3 ids so newly created sessions keep their `activity_types` metadata aligned with consumer discovery surfaces.
- Venue verification deep-links now carry the selected taxonomy tier3 id + source metadata into `/admin/new`, and the admin form surfaces a contextual prefill banner/summary/reset control so hosts understand and can clear the imported filters before publishing.
- The create-event prefill helpers now live in `apps/doWhat-web/src/lib/adminPrefill.ts`, emit both single + multi `categoryIds`, and have Jest coverage to keep host tooling links + banners stable.
- The admin sessions dashboard and manage table now surface "Plan another" links on every row using `buildSessionCloneQuery`, letting ops jump into `/admin/new` with the session‚Äôs activity, venue, taxonomy, coordinates, and price prefilled.
- `/admin/sessions` now has RTL coverage to keep the clone links + unauthorized gate stable while we iterate on host tooling.
- The main `/admin` dashboard now has RTL coverage guarding its Plan another links (ensuring venue addresses/coords flow into `buildSessionCloneQuery`) and the allowlist gate.
- Added dedicated Jest coverage for the session clone helper path so future host-tooling tweaks don‚Äôt regress the deep links wiring.
- `/admin/new` now has RTL coverage around the prefill banner + summary plus the "Clear prefills" control, so multi-category clones and reset behavior stay regression-safe while we keep iterating on host tooling.
- The `/admin/new` summary now echoes any prefilled `venueAddress` even when no venue id/name is passed, and the amber warning banner now triggers for address- or coordinate-only prefills so ops still confirm the location when clone links omit other venue metadata.
- `/admin/new` now surfaces an amber warning when prefills arrive without venue addresses or coordinates, nudging ops to verify the location context from clone links before publishing.
- `/admin/new` now shows prefilled coordinates in the summary even when clone links only provide one of latitude/longitude, surfacing a placeholder for the missing value so ops immediately spot incomplete venue data.
- Added a Playwright smoke suite (`apps/doWhat-web/tests/e2e/health.spec.ts`) plus repo-level config so `npx playwright test --project=chromium` spins up the Next dev server, hits `/api/health`, and fails fast if the host tooling surfaces ever regress the health endpoint.
- Added a Playwright admin gate suite (`apps/doWhat-web/tests/e2e/admin-gate.spec.ts`) that loads `/admin`, `/admin/sessions`, and `/admin/new` without auth to ensure the allowlist guardrail stays intact during future host-tooling edits.
- Added a `/admin/venues` Playwright flow (`apps/doWhat-web/tests/e2e/admin-venues-manage.spec.ts`) that seeds Supabase auth, mocks venues/save endpoints, skips the allowlist via the `NEXT_PUBLIC_E2E_ADMIN_BYPASS` flag, and now verifies the inline ‚ÄúAdd venue‚Äù form, the search empty state, and delete interactions end-to-end.
- The map popup now renders taxonomy badges derived from the shared tier3 index (via `activityCategoryLabels.ts`), keeping the discovery/saved experiences consistent with the Activity Filter presets while we finish the remaining Step 4 parity polish.
- The venue verification taxonomy filtering now lives in `apps/doWhat-web/src/lib/venues/taxonomySupport.ts` with Jest coverage, so the ACTIVITY_NAMES allowlist and tier3 pruning stay in sync with the shared taxonomy/library while we iterate on host map tooling.
- Venue verification Save payloads now flow through `apps/doWhat-web/src/lib/venues/savePayload.ts` (with Jest coverage) so the map list/drawer always emit the canonical metadata consumed by Saved Activities and the admin dashboards.
- Added RTL coverage for `apps/doWhat-web/src/app/venues/page.tsx` (status filter chips + Save/plan CTA wiring) using `@testing-library/user-event`, keeping the host verification parity work regression-safe while we finish the remaining Step 4 polish.
- The venue verification suite now also simulates vote success + 401 auth errors, asserting the `/api/vote-activity` flow updates counts, shows the success toast, and prompts sign-in when needed.
- The host venue verification map now surfaces the shared taxonomy picker (limited to supported activities) plus the shared distance presets, so ops review AI venues with the exact knobs consumers have on Activity Filters.
- Keep auditing discovery, session detail, map, and saved-activity experiences for any remaining host tooling gaps (tie up map detail popovers + saved lists as needed).
- Next focus: shift into Step 5 (Supabase migrations hardening) and Step 6 (admin monitoring) now that Step 4 guardrails + documentation are landed.

## 5. Harden Supabase Migrations & Seeds (Completed ¬∑ 12 Dec 2025)
- Validated migrations `025‚Äì037` via the updated health script (`scripts/health-migrations.mjs --social-sweat`) and wired the command into `pnpm health` so CI/dev machines enforce the full set automatically.
- Documented rollback dry-run steps plus seed validation queries in `docs/migrations_025-031_validation.md`, covering taxonomy, Bangkok demo, and doWhat pilot data.
- Refreshed `database_updates.sql`/`README.md` with the latest migration roster and seeding commands, ensuring every environment follows the same pipeline before deploys.

## 6. Extend Admin Monitoring & Moderation (Completed ¬∑ 6 Dec 2025)
- Enhanced the `/admin` dashboard with search, shared taxonomy filters, growth highlight cards, and an embedded audit feed backed by `admin_audit_logs`.
- Added audit prompts + logging for in-dashboard deletes and mirrored the same traceability inside `/api/cleanup` so destructive API actions capture scope + counts.
- Shipped migration `034_admin_audit_logs.sql` plus a guarded export endpoint (`/api/admin/audit-logs`) that returns JSON or CSV downloads for allowlisted admins; future monitoring tweaks are now incremental.

## 7. Documentation & Change Tracking (Ongoing)
- Keep `ASSISTANT_CHANGES_LOG.md` and `docs/current_app_overview_2025-12-03.md` synchronized after every change to prevent context loss.
- Summarize completed roadmap items and note testing/migration follow-ups as they land.

This roadmap will evolve as features land; revisit after each milestone to reprioritize remaining work.

## Active Work ‚Äî 14 Dec 2025
Roadmap execution for Sprint 5 is complete; the entries below simply document the final guardrail runs captured on 14 Dec so reviewers can trace the hand-off evidence.
- Mobile guardrail sweep: re-ran `pnpm --filter doWhat-mobile test -- --maxWorkers=50%` (73 suites/tests, all green) after the reliability CTA/WebBrowser mock fixes, immediately followed by `pnpm --filter doWhat-mobile exec npx expo-doctor` (15/15 checks) to confirm the managed-only Expo workspace stays healthy before moving on to the next Sprint 5 checklist item.
- Release-candidate verification: reran the checklist after the Playwright intercept fix (`pnpm -w run lint`, `pnpm -w run typecheck`, full Jest, Expo + RN Jest suites, `pnpm --filter dowhat-web exec playwright test`, `pnpm --filter doWhat-mobile exec npx expo-doctor`). Lint + typecheck stay green, the 10 admin Playwright specs now pass with Playwright‚Äôs dedicated port default (4302), and the Expo Doctor warning is cleared after deleting the mobile `ios/` + `android/` folders (managed workflow).
- 14 Dec follow-up: cleaned up the lingering lint warning in `sessions.contest-analytics.test.tsx` and reran `PLAYWRIGHT_PORT=4302 pnpm --filter dowhat-web exec playwright test` (10/10 specs, ~17s) to keep the Sprint 5 guardrails freshly validated after the mobile CTA/test work.
- Step 0 guardrail sweep: executed `pnpm test:onboarding-progress` (web OnboardingProgressBanner + people-filter suites, Expo onboarding hub/profile/nav CTA/people-filter suites) so the shared onboarding telemetry stays green after today‚Äôs reliability CTA + documentation tweaks.
- Trait policy guardrail: re-ran `node scripts/verify-trait-policies.mjs` against `kdviydoftmjuglaglsmm` using the newly shared service-role key, and every catalog/base trait/vote/RPC check reported `ok`, so Step 3‚Äôs Supabase policy matrix remains green alongside the latest dispute tooling changes.
- Shared package tests: ran `pnpm --filter @dowhat/shared test` (8 suites, 48 tests) to confirm the taxonomy, onboarding-progress, reliability scoring, and recommendation helpers remain covered before slicing commits.
- Repo lint cleanup: removed the unused onboarding helpers/imports in `apps/doWhat-mobile/src/app/onboarding/index.tsx`, `apps/doWhat-mobile/src/hooks/useOnboardingProgress.ts`, and `apps/doWhat-mobile/src/app/home.tsx`, eliminating the last eslint warnings in this branch. `pnpm -w run lint` now finishes with zero errors/warnings.
- Mobile typecheck parity: tightened the onboarding mocks (`apps/doWhat-mobile/src/app/__tests__/onboarding-index.test.tsx`, `home.findA4th.test.tsx`, `components/__tests__/OnboardingNav*`) so mock Supabase state allows `null` users and CommonJS `require` usages were replaced with typed `jest.requireActual` imports. `pnpm -w run typecheck` now passes across all packages.
- Web unit/regression suites: `pnpm --filter dowhat-web test -- --runInBand` still passes (53 suites), so the shared token + onboarding telemetry work remains green at the unit layer.
- Web Playwright: config now scopes discovery to `apps/doWhat-web/tests/e2e` (with `testMatch`/`testIgnore`), injects Supabase env defaults via dotenv + sane fallbacks, defaults to port 4302 (avoiding clashes with `web:dev` on 3002), and the `/admin/new` open-slot spec intercepts `/sessions/session-e2e-open` so deleting the session during the run no longer spams server errors. Use `npx playwright test --config apps/doWhat-web/playwright.config.ts --list` to verify the 10 admin specs; run `pnpm --filter dowhat-web exec playwright test` for actionable failures (override the port with `PLAYWRIGHT_PORT` only if you really need to share 4302).
- Mobile unit suites: `pnpm --filter doWhat-mobile test -- --maxWorkers=50%` passed (15 suites). Console noise remains expected due to mocked Home/profile logging.
- Mobile health: `pnpm --filter doWhat-mobile exec npx expo-doctor` now passes (native folders removed, managed workflow). Add `expo prebuild --clean --platform ios android` to any release prep so EAS builds reflect the latest config.
- doWhat dry run: `pnpm health` already wires `scripts/verify-social-sweat.mjs`, and we still owe one more staging rehearsal using the refreshed rollback + seed scripts prior to broader pilot access.

## Risks & Watchlist
- Playwright runner still needs process guardrails: config only targets the 10 admin specs now and defaults to its own port (4302), but `pnpm --filter dowhat-web exec playwright test` will still fail if another process already binds that port. Document freeing 4302 (or exporting a different `PLAYWRIGHT_PORT`) in the release checklist so CI/dev runs spin up the Next server cleanly.
- Expo Doctor workflow: native folders are no longer tracked; before building with EAS or running native targets locally, run `pnpm --filter doWhat-mobile exec expo prebuild --clean --platform ios android` so `app.config.js` changes propagate.
- Ranked sessions powering Find-a-4th still depend on timely Supabase data; if seed jobs or background refresh lag, the hero hides entirely. Keep an eye on the `scripts/verify-social-sweat.mjs` output and seed freshness before announcing full availability.
- Onboarding telemetry parity spans many surfaces (profile banners, nav pills, people filter, sport selector); any future CTA tweak must re-run the combined regression command or analytics will drift. Highlight this in PR templates to avoid accidental omissions.
- doWhat pilot automation currently targets Bucharest only; scaling to new cities requires parameterizing the seed + verify scripts and confirming RLS rules before reuse. Track this before declaring Step 0 ‚Äúdone‚Äù at the org level.