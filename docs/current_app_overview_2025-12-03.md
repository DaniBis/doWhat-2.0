# Current App Overview (2025-12-03)

## Monorepo Topology
- Expo/React Native mobile client in `apps/doWhat-mobile` with Supabase auth, map-centric discovery, saved activities, and session attendance flows powered by the `session_attendees` tables.
- Next.js 14 web client in `apps/doWhat-web` that mirrors discovery, activity detail, creation tools, and now an expanded admin dashboard.
- Shared TypeScript utilities under `packages/shared` (places ingestion, activity catalog, recommendations).
- Supabase SQL migrations tracked in `apps/doWhat-web/supabase/migrations` plus root-level helper scripts for seeding and health checks.

## Mobile Highlights
- **Map tab** shows city POIs fused from OSM/Foursquare. Place sheets display photos, metadata, and live session counts using `v_venue_attendance_summary`.
- **Map Save toggle** now pulls its payload from the shared `buildPlaceSavePayload` helper, layering the sheet’s venue/address overrides on top so bookmarking from the map mirrors every other Saved Activities surface.
- **Saved Activities** context lets authenticated users save/unsave venues or ad-hoc activities; optimistic updates keep UI snappy while Supabase stores `user_saved_activities` rows.
- **Home carousel** cards (“Popular nearby places”) now tap the same Saved Activities context, so members can Save/Saved those venues directly from the feed before hopping into the map or detail surfaces.
- **Nearby activities grid** on the Home screen now mirrors web parity with Save/Saved pills on each card, using linked session data to build payload metadata and letting people bookmark interesting activities without drilling into details first.
- **Upcoming sessions list** on the Home screen now embeds the Save/Saved pill on every card, building payloads from each session’s activity metadata (schedule, price, venue) so bookmarking future outings matches the rest of the parity rollout.
- **Reliability pledge onboarding** now lives at `/onboarding/reliability-pledge`, guiding members through four doWhat commitments, storing the acknowledgement/version on their profile, and handing them off to the main app once everything is confirmed.
- **Saved tab** now consumes the shared Saved Activities provider, adds pull-to-refresh, and exposes the Save/Saved pill on every row so members can unsave items inline without navigating into detail pages first.
- **Session detail** pages now call the `/api/sessions/[id]/attendance` helper for counts/status/mutations, keeping attendee previews, badges, and capacity messaging consistent with the web client while Supabase realtime keeps things fresh, and they now ship the shared Save toggle so hosts/guests can bookmark the underlying activity directly from the detail view.
- **Activity detail** screens now mirror that Save toggle: the hero builds a payload from the primary upcoming session/venue so members can bookmark an activity without leaving the venue list, keeping parity with the web hero experience.
- **People filters** now hydrate the “Popular Personality Traits Nearby” grid from the real `/api/traits/popular` endpoint, so onboarding trait picks and post-session votes immediately shape the personalization hints shown in-app, and they display a banner that routes anyone with fewer than five saved vibes over to `/onboarding-traits` before applying filters.
- **People filter reliability pledge CTA** hydrates `reliability_pledge_ack_at` from Supabase, shows a reminder card that links to `/onboarding/reliability-pledge` whenever the timestamp is missing, and now logs `trackOnboardingEntry({ source: 'people-filter-banner', platform: 'mobile', step: 'pledge', steps: pendingOnboardingSteps, pendingSteps: pendingOnboardingSteps.length, nextStep: '/onboarding/reliability-pledge' })` so analytics see the full Step 0 queue that triggered the event; Jest coverage lives in `apps/doWhat-mobile/src/app/__tests__/people-filter.test.tsx` alongside the trait banner tests.
- **Trait-based onboarding** screen now ships with the five-trait picker plus RN test coverage that exercises the selection cap, persistence RPC, and router redirect; Step 3 closed on **14 Dec 2025** after rerunning the full policy + CTA regression pack, so both platforms now have production-ready onboarding flows.
- **Profile screen** surfaces Supabase-powered trait summaries, now shows a Step 0 progress banner that lists every remaining onboarding task (with a "Next up" callout + quick link to the prioritized screen), and still renders the individual sport/traits/pledge CTAs so members can finish their stack without hunting for the flow. The Expo regression suite at `apps/doWhat-mobile/src/app/__tests__/profile.simple.cta.test.tsx` (`pnpm --filter doWhat-mobile test -- profile.simple.cta`) keeps the progress banner + CTA telemetry in sync with the Supabase data fetches.
- **Profile reliability banner** mirrors the web pledge nudges: when `reliability_pledge_ack_at` is missing we show a CTA that deep-links to `/onboarding/reliability-pledge`, fires `trackOnboardingEntry({ source: 'profile-pledge-banner', platform: 'mobile', step: 'pledge', steps: ['pledge'], pendingSteps: 1, nextStep: '/onboarding/reliability-pledge' })`, and disappears once Supabase reports the acknowledgement timestamp (covered by `apps/doWhat-mobile/src/app/__tests__/profile.simple.cta.test.tsx`).
- **Profile attendance log** now lives at `/profile/attendance-log`, opens from the reliability card’s “View attendance log” CTA, and hydrates Supabase `session_attendees` data plus the `mobile-disputes` function to list every session with status chips, dispute badges, and a pull-to-refresh control; rerun `pnpm --filter doWhat-mobile test -- apps/doWhat-mobile/src/app/__tests__/profile.simple.cta.test.tsx` after editing either the CTA handler or the screen.
- **Trait onboarding reminder** logic now lives in `packages/shared/src/traits/onboardingReminder.ts`, so the mobile Profile banner, People Filter CTA, AuthGate onboarding guard, and their web counterparts all reference the same helper while Jest coverage confirms the CTA hides automatically once five traits are saved.

## Web Highlights
- **Discovery pages** (home, discover, nearby, activities) share search filters, trait chips, saved toggles, and attendance components with the mobile logic.
- **Discovery queries now target `host_user_id`** everywhere `sessions` data is fetched (home hero, discover feed, search page, session/ActivityCard helpers, and the recommendation engine), matching the schema rename from `created_by` so the Next.js server no longer errors when Supabase omits the legacy column.
- **Session detail** mirrors the mobile attendee list, including host actions and badges, runs entirely on the `session_attendees` model, and now builds its Save/Saved toggle via the shared `buildSessionSavePayload` helper for telemetry parity.
- **Saved activities** now use the same context stack as mobile thanks to the shared `SavedActivitiesProvider`, so upcoming save/unsave UI can tap the unified helpers without reimplementing Supabase fallbacks; signed-out clicks automatically bounce to `/auth` instead of failing silently, so Save toggles always lead people toward finishing the action.
- **Activity cards & schedules** on the web now expose a Save/Saved toggle backed by the shared provider and build their payloads via the same helpers as mobile, giving discovery cards and the schedule board consistent metadata (sessions, venues, price labels) whenever someone bookmarks an activity.
- **Venue verification page** adds the same Save toggle to each list row and the detail drawer, and those payloads now run through `buildPlaceSavePayload` before layering AI confidence metadata so `/venues` stays in sync with every other place surface.
- **Map page** now surfaces the Save toggle on every nearby activity card and inside the on-map popup, so people can bookmark venues directly from either surface before deep-diving into details.
- **Places explorer** popups add the same Save toggle so curators can bookmark interesting POIs straight from the `/places` map without leaving the view.
- **Activity detail page** shows the Save toggle near the hero, reusing the shared helper to capture the primary session/venue metadata for each activity.
- **People filter** (web) shares the `/api/traits/popular` hints with mobile, replacing the static emoji list so the personalization module reflects live trait summary stats, surfaces a banner that nudges people with incomplete trait stacks over to `/onboarding/traits` (now firing `trackOnboardingEntry({ source: 'people-filter-banner', platform: 'web', step: 'traits', steps: pendingOnboardingSteps, pendingSteps: pendingOnboardingSteps.length, nextStep: '/onboarding/traits' })`), and renders the same reliability pledge reminder that links to `/onboarding/reliability-pledge` (tracking `trackOnboardingEntry({ source: 'people-filter-banner', platform: 'web', step: 'pledge', steps: pendingOnboardingSteps, pendingSteps: pendingOnboardingSteps.length, nextStep: '/onboarding/reliability-pledge' })`) whenever `reliability_pledge_ack_at` is missing.
- **My Attendance** now pulls dispute history from the strengthened `/api/disputes` endpoint (reporter-scoped GET with session metadata, capped at 50 rows), rendering a status-chip timeline with resolution notes, manual refresh, and automatic contest-button gating whenever an open/reviewing dispute exists; the RTL suite `apps/doWhat-web/src/app/my/attendance/__tests__/page.test.tsx` keeps the optimistic submission + history fetch flows regression-safe (`pnpm --filter dowhat-web test -- apps/doWhat-web/src/app/my/attendance/__tests__/page.test.tsx`).
- **Trait onboarding page** now lives at `/onboarding/traits`, gating access behind Supabase auth and embedding the shared `TraitSelector` so members can lock in their five base vibes on the web before jumping back to `/profile`.
- **Reliability pledge page** now lives at `/onboarding/reliability-pledge`, reusing the shared card component, auth guard, and reliability highlights while `/profile` surfaces a ReliabilityPledgeBanner if the acknowledgement timestamp is missing so members get nudged to finish Step 0. Copy was refreshed on **19 Dec 2025** (web + shared helper) so the commitments and success messages now use the updated doWhat tone.
- **Sport onboarding** still uses the shared `SportSelector`, now renders the skill-level choices as emerald chip buttons powered by the shared theme tokens, shows a "Next up" CTA on `/onboarding/sports`, and automatically routes members to `/onboarding/reliability-pledge` after a successful save so Step 2 flows seamlessly into the pledge on web (parity with the mobile onboarding path).
- **Onboarding hub** now lives at `/onboarding`, pulling Supabase auth/profile data server-side to show completion state for traits, sport, and the reliability pledge with quick links back into each step, so members can track Step 0 progress in one place.
- **Mobile onboarding hub** replaces the old carousel inside `apps/doWhat-mobile/src/app/onboarding/index.tsx`, mirrors the web `/onboarding` checklist by fetching Supabase traits/sport/pledge progress, prioritizes the next CTA, and now ships with RN coverage in `apps/doWhat-mobile/src/app/__tests__/onboarding-index.test.tsx` so Step 0 parity stays regression-safe on iOS/Android. Run `pnpm --filter doWhat-mobile test -- onboarding-index` after editing this screen to keep the Supabase fetch + CTA telemetry locked down.
- **Profile page** now includes an OnboardingProgressBanner that appears whenever any Step 0 task is unfinished, summarizes the remaining steps (with a "Next up" callout), and routes the CTA straight to the prioritized onboarding screen (traits, sport, or pledge) so members can jump into the right flow immediately. Run `pnpm --filter dowhat-web test -- OnboardingProgressBanner` after edits to keep the copy, pill chips, and `trackOnboardingEntry` payloads stable.
- **Onboarding telemetry** now flows through a shared `trackOnboardingEntry` helper. Every CTA (profile progress banner, sport + reliability banners, the profile Traits tab CTA, nav pill, sport selectors on both platforms, people-filter reminders on web/mobile, and the onboarding hub cards) now emits both a prioritized `step`, the `steps` array, `pendingSteps` count, **and** the `nextStep` route so analytics captures exactly which Step 0 tasks fire, how many remain, and where the CTA will send people; RTL coverage asserts the enriched payload on each surface.
- **Global nav** now surfaces a "Finish onboarding" pill (backed by Supabase trait counts plus the primary sport, play style, and selected skill level) whenever signed-in members still have Step 0 work remaining, giving them a single-click path to `/onboarding` from any page.
- **Mobile home hero** now renders the `OnboardingNavPrompt` directly under the search card. It pulls the same Supabase trait/sport/pledge progress, highlights the prioritized next step, links straight into the right onboarding route, and tracks `trackOnboardingEntry({ source: 'onboarding-nav-mobile', ... })` so analytics can differentiate this entry point. Coverage lives in `apps/doWhat-mobile/src/components/__tests__/OnboardingNavPrompt.test.tsx` (`pnpm --filter doWhat-mobile test -- OnboardingNavPrompt`).
- **Floating nav pill (mobile tabs)** now sits above the bottom tab bar via `OnboardingNavPill`, giving members a persistent "Finish onboarding" CTA that links to the prioritized route even when they navigate away from Home. It reuses the shared progress hook, fires `trackOnboardingEntry({ source: 'onboarding-nav-pill-mobile', ... })`, and is guarded by `apps/doWhat-mobile/src/components/__tests__/OnboardingNavPill.test.tsx` (`pnpm --filter doWhat-mobile test -- OnboardingNavPill`).
- **Find-a-4th hero** on the Home screen now consumes the shared `rankSessionsForUser` feed, normalizes match percentages with `normalizeRankingScore`, and emits `trackLookingForPlayersImpression` / `trackLookingForPlayersEngagement` events every time members view, tap, or save a ranked session. The top pick sits in the hero gradient while the next five cards live in a supporting carousel, and each CTA routes to `/(tabs)/sessions/[id]` immediately after logging telemetry.
- **Profile trait editor** embeds the new `TraitSelector`, letting members search the Supabase trait catalog, pick their five base vibes, and immediately refresh their profile summary without leaving `/profile`; a banner now nudges incomplete profiles toward `/onboarding/traits` to finish the five-trait stack.
- **TraitSelector regression tests** cover catalog loading, selection caps, submission success paths, **and** the new deselection/editing flow (reopening slots when someone removes a saved trait) so both onboarding and profile editors stay reliable while we continue polishing Step 3.
- **Creation/Admin tooling**: `/admin/new`, `/admin/sessions`, `/admin/venues`, `/admin/activities` provide CRUD surface for staff plus utility APIs (traits recompute, cleanup, recommendations, cron). All admin routes gate access via the `NEXT_PUBLIC_ADMIN_EMAILS` allow list, and each list now ships with Save toggles so ops can bookmark noteworthy records mid-review. The activities and venues lists now include keyword search bars, match counts, and empty-state callouts so moderators can filter large catalogs without endless scrolling, and the dashboard metrics highlight last-7-day growth vs the prior week so ops can quickly spot momentum swings.
  - The sessions + venues management views now pull the shared palette/radius tokens (surface cards, ink text styles, brand teal controls) so the entire admin toolchain mirrors the doWhat look-and-feel while keeping Save, clone, and delete controls grouped consistently.
  - The activities list adopted the same palette upgrades (surface cards, feedback states, pill buttons) plus refreshed access-denied messaging so every admin CRUD page uses the doWhat theme from the filters down to Save/Delete controls.
  - The `/admin/new` create-session flow now uses the shared palette/radius tokens for its prefill banners, cards, inputs, and CTAs so host tooling matches the refreshed sessions/venues/activities surfaces while keeping warning/success messaging on the feedback palette.
  - Those admin Save toggles now run through the same shared payload builders used on consumer surfaces, so telemetry remains consistent even when ops bookmark records from the dashboard.
  - E2E bypass guardrail: hitting any admin route with `?e2e=1` inside local/dev builds now auto-enables the bypass (production still requires `NEXT_PUBLIC_E2E_ADMIN_BYPASS`), and `playwright.config.ts` forwards `NEXT_PUBLIC_ADMIN_EMAILS` to the dev server so Playwright specs can exercise the flows without editing env files while real deployments continue to enforce the allow list.
- **NEW Admin dashboard (`/admin`)**
  - Authenticated admins view analytics cards (total users, sessions, venues, top activity categories) and can refresh live data.
  - Each card now surfaces how many records landed in the last seven days plus the delta vs the previous week, making growth trends visible without exporting data.
  - doWhat readiness now has its own card stack sourced from the new `dowhat_adoption_metrics` Supabase view (sport + skill saved, dedicated skill-level-only counts, pledge-only profiles, fully ready totals, and five-trait adoption) so ops can see how many members are pilot-ready at a glance.
  - The analytics cards, growth highlights, and readiness tiles now pull the shared theme tokens (`bg-surface`, `text-ink-*`, brand teal accents) so admin monitoring uses the same palette/radius/spacing system as the onboarding CTAs, keeping Step 0 surfaces visually aligned across the app.
  - Looking-for-players telemetry now tags every session with manual-entry flags, coordinate coverage, and a fake-session risk score whenever `/admin/new` publishes open slots, plus rolls back the session if Supabase RLS denies the insert so ops can't accidentally leave orphaned drafts.
  - Inline tables show every session + venue with delete controls to remove inappropriate content.
  - Quick links jump to the detailed admin CRUD screens.
  - Session tables now support keyword filtering so ops can zero in on venues, activity titles, or IDs without scanning the entire catalog.

**Saved Activities health checks** now live alongside the telemetry work: `pnpm --filter dowhat-web test -- SavedActivitiesContext` and `pnpm --filter doWhat-mobile test -- SavedActivitiesContext` both exercise optimistic updates, fallback reads, and telemetry taps, while `pnpm health` continues to run the migrations + Supabase checks first so these suites always sit on a verified schema before Saved Activities edits land.
`pnpm health` now runs `scripts/health-env.mjs`, the migrations checker (`scripts/health-migrations.mjs --dowhat`), the Supabase trait policy verifier (`scripts/health-trait-policies.mjs`), the Bucharest pilot verifier (`scripts/verify-dowhat.mjs`), and finally pings `/api/health`, so Step 0/3 regressions surface automatically whenever the full health check runs (and it skips gracefully if Supabase credentials are absent). When Supabase service creds aren’t available locally, export `DOWHAT_HEALTH_SKIP=1` before running the command (example: `DOWHAT_HEALTH_SKIP=1 pnpm run health && curl -s http://localhost:3002/api/health`). In that mode the final health endpoint will still respond with `{"ok":false,...,"missing":["user_traits"]}` until the Step 0 seed populates `user_traits`, which is expected for machines that haven’t replayed the doWhat data yet. Latest full run (**20 Dec 2025**) sourced `.env.local` to expose `DATABASE_URL`/`SUPABASE_DB_URL` before executing `pnpm -w run health`; the sweep reran migrations `035/038/043/044`, reconfirmed env + notification health, verified trait policies and Bucharest data, and curled `/api/health` (all green). If you skip sourcing the env file the command fails immediately, so run `set -a; source .env.local; set +a` (or export the two vars manually) before invoking the health script on fresh shells.
- Migration 033 drops the obsolete `event_participants` table and `rsvp_status` enum so only the session_attendees stack remains in the live schema (no more RSVP-era fallbacks lingering in Postgres).
- `pnpm health` now runs `scripts/health-env.mjs`, the migrations checker (`scripts/health-migrations.mjs --dowhat`), the Supabase trait policy verifier (`scripts/health-trait-policies.mjs`), the Bucharest pilot verifier (`scripts/verify-dowhat.mjs`), and finally pings `/api/health`, so Step 0/3 regressions surface automatically whenever the full health check runs (and it skips gracefully if Supabase credentials are absent). When Supabase service creds aren’t available locally, export `DOWHAT_HEALTH_SKIP=1` before running the command (example: `DOWHAT_HEALTH_SKIP=1 pnpm run health && curl -s http://localhost:3002/api/health`). In that mode the final health endpoint will still respond with `{"ok":false,...,"missing":["user_traits"]}` until the Step 0 seed populates `user_traits`, which is expected for machines that haven’t replayed the doWhat data yet. Latest rerun (**20 Dec 2025**) again sourced `.env.local` so the Postgres URLs existed before firing the command and completed without warnings.
- **Trait policy validation** has a dedicated playbook: run the commands in `README.md` to execute the web onboarding/profile + people-filter Jest suites, the Expo onboarding/profile/people-filter tests, and `node scripts/verify-trait-policies.mjs` with Supabase credentials; successful runs feed their output back into this overview and PR descriptions so Step 3 stays auditable. Latest run: **20 Dec 2025** via `node scripts/verify-trait-policies.mjs` (all checks passed against `kdviydoftmjuglaglsmm` after the final verification sweep), so the RLS/RPC matrix now reflects the refreshed reliability pledge copy + telemetry tests.
- **Onboarding CTA regression pack** (`pnpm test:onboarding-progress`) reran on **20 Dec 2025** after aligning the ReliabilityPledge Jest copy with the refreshed commitments; it still chains the web OnboardingProgressBanner + people-filter suites with the Expo onboarding hub/profile/nav CTA/people-filter suites so the shared telemetry stays green.
- **Shared package guardrail** (`pnpm --filter @dowhat/shared test`) ran on **20 Dec 2025** (8 suites/48 tests) to confirm the shared taxonomy/onboarding/reliability helpers stayed green before the final verification summary was logged.
- **Mobile guardrails** stayed green on **20 Dec 2025**: re-ran the entire Expo Jest suite with `pnpm --filter doWhat-mobile test -- --maxWorkers=50%` (73 suites/tests) after updating `sessions.contest-analytics.test.tsx` to await the attendance summary, then followed up with `pnpm --filter doWhat-mobile exec npx expo-doctor` (**15/15 checks passed**). Regenerate native projects on demand with `pnpm --filter doWhat-mobile exec expo prebuild --clean --platform ios android` before cutting an EAS build.
- **Admin e2e guardrail** refreshed again on **20 Dec 2025** via `PLAYWRIGHT_PORT=4302 pnpm --filter dowhat-web exec playwright test`, covering all 10 admin specs (gatekeeping, new-session prefills/open slots, venues CRUD, dashboard plan links, and the health probe) in ~17 seconds so the Sprint 5 checklist stays current.
- **Final verification sweep (20 Dec 2025)** covered `pnpm -w run lint`, `pnpm -w run typecheck`, `pnpm --filter dowhat-web test -- --runInBand`, `PLAYWRIGHT_PORT=4302 pnpm --filter dowhat-web exec playwright test`, `pnpm --filter doWhat-mobile test -- --maxWorkers=50%`, `pnpm --filter doWhat-mobile exec npx expo-doctor`, `pnpm test:onboarding-progress`, `pnpm --filter @dowhat/shared test`, `node scripts/verify-trait-policies.mjs`, `pnpm -w run health` (after sourcing `.env.local`), and `pnpm verify:dowhat`; every guardrail finished cleanly before logging this summary.
- **doWhat pilot validation** now lives in `docs/dowhat_pilot_validation.md`, outlining Supabase env vars, the `pnpm seed:dowhat` workflow, Expo/Next verification steps, and troubleshooting so the Bucharest demo data stays reproducible for every regression run; follow it up with `pnpm verify:dowhat` to automatically confirm hosts/venues/activities/sessions/open slots/host attendance rows after seeding. Latest verification: **20 Dec 2025** via `pnpm verify:dowhat` (ran once after the health sweep; all checks passed against `kdviydoftmjuglaglsmm`).
- **Session share previews** landed on 13 Dec: `/sessions/[id]/opengraph-image` renders the doWhat gradient card (slots needed, skill label, venue, host, schedule) and `generateMetadata` now links to it for Open Graph + Twitter cards. Verify locally by hitting the OG route in a browser (or tunneling `ngrok http 3002` so WhatsApp crawlers can reach it) before sharing session links outside the dev network.
- **Recommendation stack** combines saved traits, attendance history, and venue metadata via shared `packages/shared/src/places` + `apps/doWhat-web/src/lib/recommendations` modules.
- **Cron/API** endpoints exist for taxonomy seeding, event ingestion, health, and trait recompute.

## Outstanding Work / Risks
- SavedActivities parity now covers discovery/admin/map on web plus session detail, activity detail, top-places, nearby-activities, and the upcoming sessions list on mobile; next up is auditing any remaining feeds plus shoring up regression tests/telemetry for the shared helper.
- Trait onboarding flows now land on both clients with the shared trait catalog + onboarding RPC, the mobile picker has dedicated Jest coverage, and the Supabase RLS/RPC matrix passes via `scripts/verify-trait-policies.mjs`; remaining work is finishing any last UX polish.
- Session attendance migration now lands on both clients; the next roadmap slice focuses on Step 2 deliverables (host tools, notifications, and analytics that build on the unified `/api/sessions/[id]/attendance` stack).

This snapshot reflects the branch `feature/admin-dashboard-docs` after adding the analytics-capable admin dashboard on 2025-12-03, now with week-over-week growth deltas on the headline metrics.